States:
M (Modified): This cache has the only copy, it's dirty (different from memory).
E (Exclusive): This cache has the only copy, it's clean (same as memory).
S (Shared): This cache has a copy, others might too, it's clean.
I (Invalid): This cache line's data is not valid.
A. Locally Initiated Accesses (CPU connected to this cache requests Read/Write)
Local Read Hit (CPU reads, data in M, E, or S state):
Action: Supply data to CPU.
Bus Transaction: None.
Next State: No change (remains M, E, or S).
Local Read Miss (CPU reads, data in I state or tag mismatch):
Action: Issue BusRd (Memory Read request) on the bus.
Bus Transaction: BusRd.
Response & Next State (depends on snooped responses from other caches):
If another cache has it in M: That cache writes back its data to memory, puts the data on the bus. This cache grabs the data. Next State: S. (The M cache also goes to S).
If another cache has it in E: That cache puts the data on the bus. This cache grabs the data. Next State: S. (The E cache also goes to S).
If one or more other caches have it in S: One of those caches puts the data on the bus. This cache grabs the data. Next State: S. (Other S caches remain S).
If NO other cache has it (only memory): Memory supplies the data. This cache grabs the data. Next State: E.
Local Write Hit (CPU writes, data in M state):
Action: Write data to local cache line.
Bus Transaction: None (already exclusive and modified).
Next State: No change (remains M).
Local Write Hit (CPU writes, data in E state):
Action: Write data to local cache line.
Bus Transaction: None (already exclusive).
Next State: M (because it's now modified).
Local Write Hit (CPU writes, data in S state):
Action: Issue BusUpgr (Bus Upgrade, often an Invalidate signal) on the bus. Write data to local cache line.
Bus Transaction: BusUpgr/Invalidate.
Next State: M (gains exclusive, modified ownership).
Local Write Miss (CPU writes, data in I state or tag mismatch):
Action: Issue BusRdX (Read Exclusive / Read With Intent to Modify - RWITM) on the bus.
Bus Transaction: BusRdX.
Response & Next State (depends on snooped responses):
If another cache has it in M: That cache writes back its data to memory, puts the data on the bus (or just invalidates and memory supplies, depending on exact protocol variant). This cache grabs the data, writes to it. Next State: M. (The M cache goes to I).
If another cache has it in E: That cache invalidates its copy. This cache grabs the data (from memory or the E cache before invalidation), writes to it. Next State: M. (The E cache goes to I).
If one or more other caches have it in S: Those caches invalidate their copies. This cache grabs the data (from memory or an S cache before invalidation), writes to it. Next State: M. (The S caches go to I).
If NO other cache has it (only memory): Memory supplies the data. This cache grabs the data, writes to it. Next State: M.
B. Remotely Initiated Accesses (This cache snoops a bus transaction from ANOTHER CPU)
The address on the bus must match the address of this cache line for a state change to occur.
Snooped: BusRd (Another CPU requests to read this block)
If current state is M:
Action: Put local data on the bus. Write local data back to main memory.
Bus Transaction by this cache: Supply data, Writeback to memory.
Next State: S.
If current state is E:
Action: Put local data on the bus.
Bus Transaction by this cache: Supply data.
Next State: S.
If current state is S:
Action: (May or may not supply data, depends on who responds first).
Bus Transaction by this cache: Potentially supply data (if designated responder).
Next State: No change (remains S).
If current state is I:
Action: None.
Next State: No change (remains I).
Snooped: BusRdX / RWITM (Another CPU requests to write this block)
If current state is M:
Action: Put local data on the bus (or let memory handle it after writeback). Write local data back to main memory. Invalidate local copy.
Bus Transaction by this cache: Supply data (optional), Writeback to memory.
Next State: I.
If current state is E:
Action: Invalidate local copy.
Bus Transaction by this cache: None (or an ack).
Next State: I.
If current state is S:
Action: Invalidate local copy.
Bus Transaction by this cache: None (or an ack).
Next State: I.
If current state is I:
Action: None.
Next State: No change (remains I).
Snooped: BusUpgr / Invalidate (Another CPU with a Shared copy is writing to this block)
If current state is S:
Action: Invalidate local copy.
Bus Transaction by this cache: None (or an ack).
Next State: I.
If current state is M, E, or I:
Action: None (M and E shouldn't happen if another has S and is upgrading. I has no valid data).
Next State: No change.